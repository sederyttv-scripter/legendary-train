--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")

--// Vars
local me = Players.LocalPlayer
local HitboxMode = false
local loopRunning = false
local lastTrue = 0
local cooldown = 0.5 -- seconds

--// Animation Checker
local function isAnimationPlaying(ids)
	local now = tick()
	local hum = me.Character and me.Character:FindFirstChildOfClass("Humanoid")
	local animator = hum and hum:FindFirstChildOfClass("Animator")
	if not animator then return false end

	if typeof(ids) ~= "table" then ids = { ids } end

	for _, track in ipairs(animator:GetPlayingAnimationTracks()) do
		local animId = track.Animation.AnimationId:match("%d+")
		for _, id in ipairs(ids) do
			if animId == tostring(id) then
				local elapsed = now - lastTrue
				if elapsed == 0 or elapsed > cooldown then
					lastTrue = now
					return true
				elseif elapsed <= 1 then
					return true
				else
					return false
				end
			end
		end
	end
	return false
end

--// UI Setup (reworked style)
local gui = Instance.new("ScreenGui")
gui.Name = "RoyHitboxUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = CoreGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 180, 0, 60)
frame.Position = UDim2.new(0.5, -90, 0.2, 0)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 12)
uicorner.Parent = frame

local stroke = Instance.new("UIStroke")
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(90, 150, 255)
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
stroke.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 20)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(200, 200, 200)
title.TextSize = 14
title.Text = "Hitbox Controller"
title.Parent = frame

local button = Instance.new("TextButton")
button.Size = UDim2.new(1, -20, 0, 30)
button.Position = UDim2.new(0, 10, 0, 25)
button.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 16
button.Text = "Hitbox: OFF"
button.Parent = frame

local bcorner = Instance.new("UICorner")
bcorner.CornerRadius = UDim.new(0, 8)
bcorner.Parent = button

-- cooldown display loop
task.spawn(function()
	while true do
		RunService.RenderStepped:Wait()
		if HitboxMode then
			local now = tick()
			local elapsed = now - lastTrue
			if elapsed < cooldown and elapsed > 0.4 then
				local remaining = math.max(0, cooldown - elapsed)
				button.Text = ("Hitbox: Cooldown (%.1f)"):format(remaining)
			else
				button.Text = "Hitbox: ON"
			end
		else
			button.Text = "Hitbox: OFF"
		end
	end
end)

--// Root fetcher
local function getRoot(character)
	return character and character:FindFirstChild("HumanoidRootPart")
end

--// Nearest Humanoid Finder
local checkBoxSize = Vector3.new(100, 50, 100)

local function isDescendantOf(obj, parent)
	return obj and parent and obj:IsDescendantOf(parent)
end

local function getNearestHumanoid()
	if not me.Character then return nil end
	local root = getRoot(me.Character)
	if not root then return nil end

	local char = me.Character
	local isSurvivor = isDescendantOf(char, Workspace.Players:FindFirstChild("Survivors"))
	local isKiller = isDescendantOf(char, Workspace.Players:FindFirstChild("Killers"))

	local targetGroup = nil
	if isSurvivor then
		targetGroup = Workspace.Players:FindFirstChild("Killers")
	elseif isKiller then
		targetGroup = Workspace.Players:FindFirstChild("Survivors")
	end

	local parts = Workspace:GetPartBoundsInBox(root.CFrame, checkBoxSize)
	local nearest, dist = nil, math.huge

	for _, part in pairs(parts) do
		local c = part:FindFirstAncestorOfClass("Model")
		if c and c:FindFirstChild("Humanoid") and c:FindFirstChild("HumanoidRootPart") then
			if c ~= me.Character and c.Humanoid.Health > 0 then
				_G.IsNpc = false
				local valid = false
				if targetGroup then
					valid = isDescendantOf(c, targetGroup)
				else
					valid = true
				end
				if valid then
					local hrp = c.HumanoidRootPart
					local d = (hrp.Position - root.Position).Magnitude
					if d < dist then
						dist = d
						nearest = hrp
					end
				end
			end
		end
	end

	if not nearest then
		for _, part in pairs(parts) do
			local c = part:FindFirstAncestorOfClass("Model")
			if c and c:FindFirstChild("Humanoid") and c:FindFirstChild("HumanoidRootPart") then
				if c ~= me.Character and c.Humanoid.Health > 0 then
					_G.IsNpc = true
					local hrp = c.HumanoidRootPart
					local d = (hrp.Position - root.Position).Magnitude
					if d < dist then
						dist = d
						nearest = hrp
					end
				end
			end
		end
	end

	return nearest
end

--// Hitbox Loop
local function startHitboxMode()
	if loopRunning then return end
	loopRunning = true

	task.spawn(function()
		while HitboxMode do
			RunService.Heartbeat:Wait()
			local character = me.Character
			local root = getRoot(character)
			local vel, movel = nil, 0.1

			while not (character and character.Parent and root and root.Parent) do
				RunService.Heartbeat:Wait()
				character = me.Character
				root = getRoot(character)
			end

			vel = root.Velocity
			local ids = {
				126830014841198, 126355327951215, 121086746534252, 18885909645,
				106776364623742, 105458270463374, 106538427162796, 126896426760253,
				83829782357897, 116618003477002, 86545133269813, 106014898528300,
				87259391926321, 133491532453922, 98031287364865, 119462383658044,
				77448521277146, 103741352379819, 131696603025265, 122503338277352,
				97648548303678, 94162446513587, 84426150435898, 93069721274110,
				114620047310688, 97433060861952, 82183356141401, 100592913030351,
				121293883585738, 70447634862911, 92173139187970, 106847695270773,
				125403313786645, 81639435858902, 137314737492715, 120112897026015,
				82113744478546, 118298475669935, 126681776859538, 129976080405072,
				109667959938617, 74707328554358, 133336594357903, 86204001129974,
				124243639579224, 70371667919898, 131543461321709, 136323728355613
			}

			if isAnimationPlaying(ids) then
				local target = getNearestHumanoid()
				if target then
					local futurePos
					if not _G.IsNpc then
						local predictionTime = 1.2
						futurePos = target.Position + target.Velocity * predictionTime
					else
						futurePos = target.Position
					end
					local offset = futurePos - root.Position
					local distance = offset.Magnitude
					local direction = offset.Unit
					local speed = distance * 6
					root.Velocity = vel + Vector3.new(direction.X * speed, direction.Y * speed, direction.Z * speed)
				end
			end

			RunService.RenderStepped:Wait()
			if character and root then
				root.Velocity = vel
			end

			RunService.Stepped:Wait()
			if character and root then
				root.Velocity = vel + Vector3.new(0, movel, 0)
				movel = -movel
			end
		end
		loopRunning = false
	end)
end

--// Toggle button
button.MouseButton1Click:Connect(function()
	HitboxMode = not HitboxMode
	if HitboxMode then
		startHitboxMode()
	end
end)
